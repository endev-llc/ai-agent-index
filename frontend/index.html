<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Index Interface</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <nav class="bg-blue-600 p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-white text-2xl font-bold">AI Agent Index</h1>
                <p class="text-blue-100 text-sm">Network: Base Sepolia Testnet</p>
            </div>
            <div>
                <button id="connectWallet" class="bg-white text-blue-600 px-4 py-2 rounded hover:bg-blue-50">
                    Connect Wallet
                </button>
                <span id="walletAddress" class="text-white ml-2"></span>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4">
        <!-- Tab Navigation -->
        <div class="flex space-x-2 mb-4">
            <button class="tab-button bg-blue-500 text-white px-4 py-2 rounded" data-tab="search">Search</button>
            <button class="tab-button bg-blue-500 text-white px-4 py-2 rounded wallet-required" data-tab="add">Add Agent</button>
            <button class="tab-button bg-blue-500 text-white px-4 py-2 rounded wallet-required" data-tab="manage">Manage Agent</button>
            <button class="tab-button bg-blue-500 text-white px-4 py-2 rounded wallet-required" data-tab="admin">Admin</button>
        </div>

        <!-- Search Tab -->
        <div id="search" class="tab-content active bg-white rounded-lg shadow p-4">
            <h2 class="text-xl font-bold mb-4">Search AI Agents</h2>
            <div class="mb-6">
                <form id="searchForm" class="relative">
                    <input type="text" 
                           id="searchInput" 
                           class="w-full p-4 pr-12 text-lg border rounded-lg focus:outline-none focus:border-blue-500" 
                           placeholder="Search agents by any field... (Press Enter to search)"
                           minlength="2"
                           required>
                    <button type="submit" class="absolute right-4 top-4 text-gray-400">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </button>
                </form>
                <p class="text-sm text-gray-500 mt-2">Results are ranked by relevance: name matches first, then descriptions, then other fields</p>
            </div>
            <div id="searchResults" class="mt-4 space-y-4"></div>
            <div id="loadingIndicator" class="hidden">
                <div class="flex justify-center items-center p-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                </div>
            </div>
        </div>

        <!-- Add Agent Tab -->
        <div id="add" class="tab-content bg-white rounded-lg shadow p-4">
            <div class="wallet-notice bg-yellow-100 p-4 rounded mb-4">Please connect your wallet to add an agent.</div>
            <div class="wallet-content hidden">
                <h2 class="text-xl font-bold mb-4">Add New Agent</h2>
                <form id="addAgentForm" class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block mb-2">Name</label>
                        <input type="text" id="agentName" class="w-full p-2 border rounded" required>
                    </div>
                    <div>
                        <label class="block mb-2">Address</label>
                        <input type="text" id="agentAddress" class="w-full p-2 border rounded" required>
                    </div>
                    <div>
                        <label class="block mb-2">Social Link</label>
                        <input type="text" id="agentSocial" class="w-full p-2 border rounded" required>
                    </div>
                    <div>
                        <label class="block mb-2">Profile URL</label>
                        <input type="text" id="agentProfile" class="w-full p-2 border rounded" required>
                    </div>
                    <div>
                        <label class="block mb-2">Description</label>
                        <textarea id="agentDescription" class="w-full p-2 border rounded" rows="4" required></textarea>
                    </div>
                    <div>
                        <label class="block mb-2">Admin Address (Optional)</label>
                        <input type="text" id="adminAddress" class="w-full p-2 border rounded">
                    </div>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Add Agent</button>
                </form>
            </div>
        </div>

        <!-- Manage Agent Tab -->
        <div id="manage" class="tab-content bg-white rounded-lg shadow p-4">
            <div class="wallet-notice bg-yellow-100 p-4 rounded mb-4">Please connect your wallet to manage agents.</div>
            <div class="wallet-content hidden">
                <h2 class="text-xl font-bold mb-4">Manage Agent</h2>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block mb-2">Agent ID</label>
                        <input type="number" id="manageAgentId" class="w-full p-2 border rounded" min="0">
                        <button onclick="getAgentDetails()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Get Details</button>
                    </div>
                    <div id="agentDetails" class="hidden"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="deactivateAgent()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Deactivate</button>
                        <button onclick="reactivateAgent()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Reactivate</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="admin" class="tab-content bg-white rounded-lg shadow p-4">
            <div class="wallet-notice bg-yellow-100 p-4 rounded mb-4">Please connect your wallet to access admin functions.</div>
            <div class="wallet-content hidden">
                <h2 class="text-xl font-bold mb-4">Admin Functions</h2>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block mb-2">New Listing Fee (ETH)</label>
                        <input type="number" id="newFee" class="w-full p-2 border rounded" step="0.0001">
                        <button onclick="setListingFee()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Update Fee</button>
                    </div>
                    <div>
                        <label class="block mb-2">New Fee Collector Address</label>
                        <input type="text" id="newCollector" class="w-full p-2 border rounded">
                        <button onclick="setFeeCollector()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Update Collector</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Contract configuration
        const CONTRACT_ADDRESS = '0xDe438021611C7878ECeb271FCEF15Fc12890019f';
        const RPC_URL = 'https://sepolia.base.org';
        const CONTRACT_ABI = [
            "function searchByKeyword(string) view returns (tuple(uint256 id, tuple(string name, string address_, string socialLink, string profileUrl, string description, bool isActive, uint256 addedAt, address owner, uint256 lastUpdateTime, string admin_address))[])",
            "function addAgent(string,string,string,string,string,string) payable returns (uint256)",
            "function updateAgent(uint256,string,string,string,string,string)",
            "function deactivateAgent(uint256)",
            "function reactivateAgent(uint256) payable",
            "function getAgent(uint256) view returns (tuple(string name, string address_, string socialLink, string profileUrl, string description, bool isActive, uint256 addedAt, address owner, uint256 lastUpdateTime, string admin_address))",
            "function setListingFee(uint256)",
            "function setFeeCollector(address)",
            "function listingFee() view returns (uint256)",
            "function owner() view returns (address)"
        ];

        // Initialize providers
        let readProvider;
        let writeProvider;
        let readContract;
        let writeContract;
        
        // Initialize read-only provider immediately
        async function initializeReadProvider() {
            try {
                readProvider = new ethers.JsonRpcProvider(RPC_URL);
                readContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readProvider);
                console.log('Read provider initialized successfully');
            } catch (error) {
                console.error('Error initializing read provider:', error);
            }
        }
        
        // Initialize on page load
        window.addEventListener('load', () => {
            initializeReadProvider();
            setupSearchForm();
        });

        function setupSearchForm() {
            document.getElementById('searchForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const searchTerm = document.getElementById('searchInput').value.trim();
                
                if (searchTerm.length < 2) {
                    document.getElementById('searchResults').innerHTML = 
                        '<p class="text-gray-600 text-center py-4">Please enter at least 2 characters</p>';
                    return;
                }

                const loadingIndicator = document.getElementById('loadingIndicator');
                loadingIndicator.classList.remove('hidden');
                
                try {
                    console.log('Searching for:', searchTerm);
                    const results = await readContract.searchByKeyword(searchTerm);
                    
                    if (!results || !Array.isArray(results)) {
                        throw new Error('Invalid response format');
                    }
                    
                    // Process and format the results
                    const formattedResults = results.map(result => {
                        const id = Number(result[0]) || 0; // Ensure numeric ID
                        const agentData = result[1] || {}; // Extract agent data
                        
                        return {
                            id,
                            agent: {
                                name: agentData.name || '',
                                address_: agentData.address_ || '',
                                socialLink: agentData.socialLink || '',
                                profileUrl: agentData.profileUrl || '',
                                description: agentData.description || '',
                                isActive: Boolean(agentData.isActive),
                                addedAt: Number(agentData.addedAt) || 0,
                                owner: agentData.owner || '',
                                lastUpdateTime: Number(agentData.lastUpdateTime) || 0,
                                admin_address: agentData.admin_address || ''
                            }
                        };
                    }).filter(result => result.id > 0); // Filter out invalid results
                    
                    // Calculate relevance scores and display results
                    const scoredResults = formattedResults
                        .map(result => ({
                            ...result,
                            relevanceScore: calculateRelevanceScore(result.agent, searchTerm)
                        }))
                        .filter(result => result.relevanceScore > 0)
                        .sort((a, b) => b.relevanceScore - a.relevanceScore);

                    displaySearchResults(scoredResults, searchTerm);
                } catch (error) {
                    console.error('Error searching:', error);
                    document.getElementById('searchResults').innerHTML = 
                        '<p class="text-red-500 text-center py-4">An error occurred while searching. Please try again.</p>';
                } finally {
                    loadingIndicator.classList.add('hidden');
                }
            });
        }

        // Wallet connection
        document.getElementById('connectWallet').addEventListener('click', async () => {
            if (!window.ethereum) {
                alert('Please install MetaMask!');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                writeProvider = new ethers.BrowserProvider(window.ethereum);
                const signer = await writeProvider.getSigner();
                writeContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                document.getElementById('walletAddress').textContent = 
                    `${accounts[0].substring(0, 6)}...${accounts[0].substring(38)}`;

                // Switch to Base Sepolia if needed
                try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '84532' }]
                        });
                    } catch (error) {
                        if (error.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '84532',
                                    chainName: 'Base Sepolia',
                                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: ['https://sepolia.base.org'],
                                    blockExplorerUrls: ['https://sepolia.basescan.org']
                                }]
                            });
                        }
                    }

                // Show wallet-required content
                document.querySelectorAll('.wallet-notice').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.wallet-content').forEach(el => el.classList.remove('hidden'));
            } catch (error) {
                console.error('Error connecting wallet:', error);
                alert('Failed to connect wallet');
            }
        });

        // Calculate relevance score for sorting
        function calculateRelevanceScore(agent, searchTerm) {
            if (!agent || !searchTerm) return 0;
            searchTerm = searchTerm.toLowerCase();
            let score = 0;
            
            // Name matches (highest priority - score: 100)
            if (agent.name && agent.name.toLowerCase().includes(searchTerm)) {
                score += 100;
                // Bonus for exact match or starts with
                if (agent.name.toLowerCase() === searchTerm) score += 50;
                if (agent.name.toLowerCase().startsWith(searchTerm)) score += 25;
            }
            
            // Description matches (second priority - score: 50)
            if (agent.description && agent.description.toLowerCase().includes(searchTerm)) {
                score += 50;
                // Bonus for starts with
                if (agent.description.toLowerCase().startsWith(searchTerm)) score += 10;
            }
            
            // Other fields (lower priority - score: 10 each)
            if (agent.address_ && agent.address_.toLowerCase().includes(searchTerm)) score += 10;
            if (agent.socialLink && agent.socialLink.toLowerCase().includes(searchTerm)) score += 10;
            if (agent.profileUrl && agent.profileUrl.toLowerCase().includes(searchTerm)) score += 10;
            if (agent.admin_address && agent.admin_address.toLowerCase().includes(searchTerm)) score += 10;
            
            return score;
        }

        function highlightText(text, searchTerm) {
            if (!searchTerm || !text) return text || '';
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<mark class="bg-yellow-200">$1</mark>');
        }

        function displaySearchResults(scoredResults, searchTerm) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '';

            if (!scoredResults || scoredResults.length === 0) {
                resultsDiv.innerHTML = '<p class="text-gray-600 text-center py-4">No matching agents found</p>';
                return;
            }

            scoredResults.forEach(({ agent, id, relevanceScore }) => {
                if (!agent || !id) return; // Skip invalid results

                const div = document.createElement('div');
                div.className = 'bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200';
                
                const highlightedName = highlightText(agent.name || '', searchTerm);
                const highlightedDescription = highlightText(agent.description || '', searchTerm);
                const highlightedAddress = highlightText(agent.address_ || '', searchTerm);

                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold text-gray-900">${highlightedName}</h3>
                        <span class="text-sm text-gray-500">ID: ${id}</span>
                    </div>
                    <p class="mt-2 text-gray-600">${highlightedDescription}</p>
                    <div class="mt-4 text-sm text-gray-500">
                        <p>Address: ${highlightedAddress}</p>
                        <div class="mt-2 flex gap-4">
                            ${agent.socialLink ? `
                                <a href="${agent.socialLink}" target="_blank" class="text-blue-500 hover:text-blue-700">
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                  d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                                        </svg>
                                        Social Profile
                                    </span>
                                </a>
                            ` : ''}
                            ${agent.profileUrl ? `
                                <a href="${agent.profileUrl}" target="_blank" class="text-blue-500 hover:text-blue-700">
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                  d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        Agent Profile
                                    </span>
                                </a>
                            ` : ''}
                        </div>
                    </div>
                    <div class="mt-4 text-xs text-gray-400 flex justify-between items-center">
                        <span>Last Updated: ${new Date(Number(agent.lastUpdateTime) * 1000).toLocaleDateString()}</span>
                        ${agent.isActive ? 
                            '<span class="text-green-500">Active</span>' : 
                            '<span class="text-red-500">Inactive</span>'}
                    </div>
                `;
                resultsDiv.appendChild(div);
            });
        }

        // Get agent details
        async function getAgentDetails() {
            const agentId = document.getElementById('manageAgentId').value;
            if (!agentId) {
                alert('Please enter an agent ID');
                return;
            }

            try {
                const agent = await readContract.getAgent(agentId);
                
                const detailsDiv = document.getElementById('agentDetails');
                detailsDiv.innerHTML = `
                    <div class="bg-gray-50 p-4 rounded mb-4">
                        <h3 class="font-bold">${agent.name}</h3>
                        <p>${agent.description}</p>
                        <p class="text-sm">
                            <strong>Address:</strong> ${agent.address_}<br>
                            <strong>Social:</strong> <a href="${agent.socialLink}" target="_blank" class="text-blue-500">${agent.socialLink}</a><br>
                            <strong>Profile:</strong> <a href="${agent.profileUrl}" target="_blank" class="text-blue-500">${agent.profileUrl}</a><br>
                            <strong>Status:</strong> ${agent.isActive ? 'Active' : 'Inactive'}<br>
                            <strong>Owner:</strong> ${agent.owner}<br>
                            <strong>Admin Address:</strong> ${agent.admin_address || 'Not set'}<br>
                            <strong>Added:</strong> ${new Date(Number(agent.addedAt) * 1000).toLocaleDateString()}<br>
                            <strong>Last Updated:</strong> ${new Date(Number(agent.lastUpdateTime) * 1000).toLocaleDateString()}
                        </p>
                    </div>
                `;
                detailsDiv.classList.remove('hidden');
            } catch (error) {
                console.error('Error getting agent details:', error);
                alert('Failed to get agent details: ' + error.message);
            }
        }

        // Add agent form submission
        document.getElementById('addAgentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!writeContract) {
                alert('Please connect your wallet first');
                return;
            }

            try {
                const fee = await readContract.listingFee();
                const tx = await writeContract.addAgent(
                    document.getElementById('agentName').value,
                    document.getElementById('agentAddress').value,
                    document.getElementById('agentSocial').value,
                    document.getElementById('agentProfile').value,
                    document.getElementById('agentDescription').value,
                    document.getElementById('adminAddress').value || '',
                    { value: fee }
                );
                
                await tx.wait();
                alert('Agent added successfully!');
                e.target.reset();
            } catch (error) {
                console.error('Error adding agent:', error);
                alert('Failed to add agent: ' + error.message);
            }
        });

        // Deactivate agent
        async function deactivateAgent() {
            if (!writeContract) {
                alert('Please connect your wallet first');
                return;
            }

            try {
                const agentId = document.getElementById('manageAgentId').value;
                const tx = await writeContract.deactivateAgent(agentId);
                await tx.wait();
                alert('Agent deactivated successfully!');
                await getAgentDetails(); // Refresh details
            } catch (error) {
                console.error('Error deactivating agent:', error);
                alert('Failed to deactivate agent: ' + error.message);
            }
        }

        // Reactivate agent
        async function reactivateAgent() {
            if (!writeContract) {
                alert('Please connect your wallet first');
                return;
            }

            try {
                const agentId = document.getElementById('manageAgentId').value;
                const fee = await readContract.listingFee();
                const tx = await writeContract.reactivateAgent(agentId, { value: fee });
                await tx.wait();
                alert('Agent reactivated successfully!');
                await getAgentDetails(); // Refresh details
            } catch (error) {
                console.error('Error reactivating agent:', error);
                alert('Failed to reactivate agent: ' + error.message);
            }
        }

        // Set listing fee
        async function setListingFee() {
            if (!writeContract) {
                alert('Please connect your wallet first');
                return;
            }

            try {
                const newFee = ethers.parseEther(document.getElementById('newFee').value);
                const tx = await writeContract.setListingFee(newFee);
                await tx.wait();
                alert('Listing fee updated successfully!');
            } catch (error) {
                console.error('Error updating listing fee:', error);
                alert('Failed to update listing fee: ' + error.message);
            }
        }

        // Set fee collector
        async function setFeeCollector() {
            if (!writeContract) {
                alert('Please connect your wallet first');
                return;
            }

            try {
                const newCollector = document.getElementById('newCollector').value;
                const tx = await writeContract.setFeeCollector(newCollector);
                await tx.wait();
                alert('Fee collector updated successfully!');
            } catch (error) {
                console.error('Error updating fee collector:', error);
                alert('Failed to update fee collector: ' + error.message);
            }
        }

        // Tab handling
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                // If tab requires wallet and wallet isn't connected, show alert
                if (button.classList.contains('wallet-required') && !writeContract) {
                    alert('Please connect your wallet to access this feature');
                    return;
                }
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(button.dataset.tab).classList.add('active');
            });
        });

        // Network display
        async function displayCurrentNetwork() {
            if (window.ethereum) {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const networkName = chainId === '84532' ? 'Base Sepolia Testnet' : 'Unknown Network';
                document.querySelector('.text-blue-100').textContent = `Network: ${networkName}`;
            }
        }

        // Initialize network display
        displayCurrentNetwork();
        if (window.ethereum) {
            window.ethereum.on('chainChanged', displayCurrentNetwork);
        }
    </script>
</body>
</html>